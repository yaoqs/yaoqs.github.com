{"type":"getPostById","data":{"title":"用 C++ 修改本地安全策略","date":"2024-03-24T12:34:55.000Z","description":"","categories":[],"tags":[],"content":"<link rel=\"stylesheet\" type=\"text&#x2F;css\" href=\"https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css\"><p>转载自 <a href=\"http://www.blogjava.net/baicker/archive/2008/01/30/178511.html\">用 C++ 修改本地安全策略</a></p>\n<p>(更新：注意编译运行文中程序后留意 administrator 可能会变成 active=no，undocument，undocument… 哈哈)<br>\n要写个修改本地安全策略的工具，本以为修改注册表就行了，没想到还挺复杂，改策略，对应的注册表项会变，倒过来，改对应的注册表项，策略没变，郁闷<br>\n[HKEY_LOCAL_MACHINE\\SAM\\SAM\\Domains\\Account]&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; |-------------------------------- 修改次数<br>\n“F”=hex:02,00,01,00,00,00,00,00,e0,7c,9e,21,1a,12,c6,01,43,00,00,00,00,00,00,\\&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 00 ~ 22<br>\n&nbsp; 00,00,80,d2,16,47,b9,ff,ff,00,80,2c,ab,6d,fe,ff,ff,00,00,00,00,00,00,00,80,\\&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 23 ~ 47<br>\n&nbsp; 00,cc,1d,cf,fb,ff,ff,ff,00,cc,1d,cf,fb,ff,ff,ff,00,00,00,00,00,00,00,00,f1,\\&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 48 ~ 72<br>\n&nbsp; 03,00,00,00,00,00,00,02,00,18,00,00,00,00,00,01,00,00,00,03,00,00,00,01,00,\\&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 73 ~ 97<br>\n&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ^^&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ^<br>\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ||&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; |<br>\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ||&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; |__ 密码长度最小值<br>\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ||<br>\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ||__&nbsp;&nbsp;&nbsp; 密码必须符合复杂性要求 (0 为禁止)<br>\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; |___ 用可还原的加密来存储密码</p>\n<p>第 76 80 位</p>\n<p>[HKEY_LOCAL_MACHINE\\SAM\\SAM\\Domains\\Account\\Users\\000001F5]<br>\n“F”=hex:02,00,01,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\<br>\n&nbsp; 00,80,c6,50,1f,2b,12,c6,01,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\<br>\n&nbsp; f5,01,00,00,01,02,00,00,15,02,00,00,00,00,00,00,00,00,00,00,00,00,00,00,00,\\<br>\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ^<br>\n&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; |____ Guest 账号 (15 禁用，14 启用)</p>\n<p>第 56 位</p>\n<p>比如第 76 位，<br>\n0 的时候是 \"密码必须符合复杂性要求 - 禁用\" &amp; “用可还原的加密来存储密码 - 禁用”<br>\n14 的时候 \"密码必须符合复杂性要求 - 禁用\" &amp; “用可还原的加密来存储密码 - 启用”</p>\n<p>有些比如密码长度，锁定什么的用 NetUserModalsSet 的 USER_MODALS_INFO_0 和 USER_MODALS_INFO_3 结构可以搞定。<br>\n审核策略用 LsaSetInformationPolicy 也好搞定，都有现成的代码。</p>\n<p>账户策略 -&gt; 密码策略中的 \"密码必须符合复杂性要求\" 和 \"用可还原的加密来存储密码\"，还有安全选项中的内容，似乎没有公开文档</p>\n<p>没想到写个这个破工具还要用到未公开 API 函数，之前在网上查了下有没有相关代码或文档什么的，查了 N 天 google 和 MSDN，有问的，没有答的，或者就是答非所问，没办法只能自己想办法了<br>\n之前使用 apimonitor（N 多此类工具，都不好用，这个也不咋样），在修改策略的时候获得了如下信息</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">API&nbsp;&nbsp;&nbsp; Name&nbsp;&nbsp;&nbsp; Return&nbsp;&nbsp;&nbsp; Value&nbsp;&nbsp;&nbsp; Module&nbsp;&nbsp;&nbsp; Name&nbsp;&nbsp;&nbsp; Time&nbsp;&nbsp;&nbsp; Start&nbsp;&nbsp;&nbsp; IsEntry&nbsp;&nbsp;&nbsp; API  </span><br><span class=\"line\">Process:&nbsp;&nbsp;&nbsp; c:\\\\windows\\\\system32\\\\mmc.exe(5052)&nbsp;&nbsp;&nbsp; ,&nbsp;&nbsp;&nbsp; Thread:2976  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceOpenProfile&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetSecurityProfileInfo&nbsp;&nbsp;&nbsp; 6&nbsp;&nbsp;&nbsp; (0x6)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeMemory&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetSecurityProfileInfo&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeMemory&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:38&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:34&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:34&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetServerProductType&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:34&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceRollbackTransaction&nbsp;&nbsp;&nbsp; 12&nbsp;&nbsp;&nbsp; (0xC)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:55&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceCloseProfile&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:55&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeProfileMemory&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:55&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeProfileMemory&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:55&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeProfileMemory&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:55&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeProfileMemory&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp; (0x1)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:55&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">Process:&nbsp;&nbsp;&nbsp; c:\\\\windows\\\\system32\\\\mmc.exe(5052)&nbsp;&nbsp;&nbsp; ,&nbsp;&nbsp;&nbsp; Thread:3928  </span><br><span class=\"line\">SceOpenProfile&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:49&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceGetSecurityProfileInfo&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:49&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceCloseProfile&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:49&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeMemory&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:49&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeMemory&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:49&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceFreeMemory&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:56&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceUpdateSecurityProfile&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:10:56&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">Process:&nbsp;&nbsp;&nbsp; c:\\\\windows\\\\system32\\\\mmc.exe(5052)&nbsp;&nbsp;&nbsp; ,&nbsp;&nbsp;&nbsp; Thread:5472  </span><br><span class=\"line\">SceFreeMemory&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:43&nbsp;&nbsp;&nbsp; True  </span><br><span class=\"line\">SceUpdateSecurityProfile&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; (0x0)&nbsp;&nbsp;&nbsp; C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll&nbsp;&nbsp;&nbsp; 2008-1-27&nbsp;&nbsp;&nbsp; 23:11:43&nbsp;&nbsp;&nbsp; True</span><br><span class=\"line\"></span><br><span class=\"line\">Summary Information  </span><br><span class=\"line\">API Name: SceOpenProfile  </span><br><span class=\"line\">API Define: (Undefine API)  </span><br><span class=\"line\">Time Start: 00:11:49.015  </span><br><span class=\"line\">Duration: 0.000 ms  </span><br><span class=\"line\">Module Name: C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll  </span><br><span class=\"line\">Is Entry API: True  </span><br><span class=\"line\">Process: C:\\\\WINDOWS\\\\system32\\\\mmc.exe  </span><br><span class=\"line\">Thread: 4152  </span><br><span class=\"line\">Before Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 29449864 (0x1C15E88)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 1 (0x1)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 23981584 (0x16DEE10)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: 8629392 (0x83AC90)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: (null)  </span><br><span class=\"line\">After Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 29449864 (0x1C15E88)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 1 (0x1)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 23981584 (0x16DEE10)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: 8629392 (0x83AC90)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: (null)  </span><br><span class=\"line\">Return  </span><br><span class=\"line\">0 (0x0)</span><br><span class=\"line\"></span><br><span class=\"line\">Summary Information  </span><br><span class=\"line\">API Name: SceGetSecurityProfileInfo  </span><br><span class=\"line\">API Define: (Undefine API)  </span><br><span class=\"line\">Time Start: 00:11:49.015  </span><br><span class=\"line\">Duration: 0.001 ms  </span><br><span class=\"line\">Module Name: C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll  </span><br><span class=\"line\">Is Entry API: True  </span><br><span class=\"line\">Process: C:\\\\WINDOWS\\\\system32\\\\mmc.exe  </span><br><span class=\"line\">Thread: 4152  </span><br><span class=\"line\">Before Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 688576 (0xA81C0)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 302 (0x12E)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 65535 (0xFFFF)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 8629480 (0x83ACE8)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: 23981572 (0x16DEE04)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 2088955995 (0x7C82F05B)  </span><br><span class=\"line\">After Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 688576 (0xA81C0)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 302 (0x12E)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 65535 (0xFFFF)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 8629480 (0x83ACE8)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: 23981572 (0x16DEE04)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 2088955995 (0x7C82F05B)  </span><br><span class=\"line\">Return  </span><br><span class=\"line\">0 (0x0)  </span><br><span class=\"line\">GetLastError  </span><br><span class=\"line\">Value:3758096642  </span><br><span class=\"line\">Description:</span><br><span class=\"line\"></span><br><span class=\"line\">Summary Information  </span><br><span class=\"line\">API Name: SceCloseProfile  </span><br><span class=\"line\">API Define: (Undefine API)  </span><br><span class=\"line\">Time Start: 00:11:49.109  </span><br><span class=\"line\">Duration: 0.000 ms  </span><br><span class=\"line\">Module Name: C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll  </span><br><span class=\"line\">Is Entry API: True  </span><br><span class=\"line\">Process: C:\\\\WINDOWS\\\\system32\\\\mmc.exe  </span><br><span class=\"line\">Thread: 4152  </span><br><span class=\"line\">Before Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 23981584 (0x16DEE10)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 2088955995 (0x7C82F05B)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 8629392 (0x83AC90)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 8570560 (0x82C6C0)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: 8629296 (0x83AC30)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 302124616 (0x12020E48)  </span><br><span class=\"line\">After Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 23981584 (0x16DEE10)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 2088955995 (0x7C82F05B)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 8629392 (0x83AC90)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 8570560 (0x82C6C0)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: 8629296 (0x83AC30)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 302124616 (0x12020E48)  </span><br><span class=\"line\">Return  </span><br><span class=\"line\">0 (0x0)</span><br><span class=\"line\"></span><br><span class=\"line\">Summary Information  </span><br><span class=\"line\">API Name: SceAddToNameStatusList  </span><br><span class=\"line\">API Define: (Undefine API)  </span><br><span class=\"line\">Time Start: 00:11:49.109  </span><br><span class=\"line\">Duration: 0.000 ms  </span><br><span class=\"line\">Module Name: C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll  </span><br><span class=\"line\">Is Entry API: True  </span><br><span class=\"line\">Process: C:\\\\WINDOWS\\\\system32\\\\mmc.exe  </span><br><span class=\"line\">Thread: 4152  </span><br><span class=\"line\">Before Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 23981476 (0x16DEDA4)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 787520 (0xC0440)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 76 (0x4C)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 1 (0x1)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 8629392 (0x83AC90)  </span><br><span class=\"line\">After Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 23981476 (0x16DEDA4)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 787520 (0xC0440)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 76 (0x4C)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 1 (0x1)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 8629392 (0x83AC90)  </span><br><span class=\"line\">Return  </span><br><span class=\"line\">0 (0x0)</span><br><span class=\"line\"></span><br><span class=\"line\">Summary Information  </span><br><span class=\"line\">API Name: SceFreeMemory  </span><br><span class=\"line\">API Define: (Undefine API)  </span><br><span class=\"line\">Time Start: 00:11:49.109  </span><br><span class=\"line\">Duration: 0.000 ms  </span><br><span class=\"line\">Module Name: C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll  </span><br><span class=\"line\">Is Entry API: True  </span><br><span class=\"line\">Process: C:\\\\WINDOWS\\\\system32\\\\mmc.exe  </span><br><span class=\"line\">Thread: 4152  </span><br><span class=\"line\">Before Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 1514080 (0x171A60)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 311 (0x137)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 8629392 (0x83AC90)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 4 (0x4)  </span><br><span class=\"line\">After Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: 1514080 (0x171A60)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 311 (0x137)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 8629392 (0x83AC90)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 4 (0x4)  </span><br><span class=\"line\">Return  </span><br><span class=\"line\">0 (0x0)</span><br><span class=\"line\"></span><br><span class=\"line\">Summary Information  </span><br><span class=\"line\">API Name: SceUpdateSecurityProfile  </span><br><span class=\"line\">API Define: (Undefine API)  </span><br><span class=\"line\">Time Start: 00:11:52.203  </span><br><span class=\"line\">Duration: 0.000 ms  </span><br><span class=\"line\">Module Name: C:\\\\WINDOWS\\\\system32\\\\SCECLI.dll  </span><br><span class=\"line\">Is Entry API: True  </span><br><span class=\"line\">Process: C:\\\\WINDOWS\\\\system32\\\\mmc.exe  </span><br><span class=\"line\">Thread: 4152  </span><br><span class=\"line\">Before Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 1 (0x1)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 28866104 (0x1B87638)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 4 (0x4)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 8629056 (0x83AB40)  </span><br><span class=\"line\">After Call Parameters  </span><br><span class=\"line\">Pointer&nbsp; Paramter0: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter1: 1 (0x1)  </span><br><span class=\"line\">Pointer&nbsp; Paramter2: 28866104 (0x1B87638)  </span><br><span class=\"line\">Pointer&nbsp; Paramter3: 4 (0x4)  </span><br><span class=\"line\">Pointer&nbsp; Paramter4: (null)  </span><br><span class=\"line\">Pointer&nbsp; Paramter5: 8629056 (0x83AB40)  </span><br><span class=\"line\">Return  </span><br><span class=\"line\">0 (0x0)</span><br></pre></td></tr></tbody></table></figure>\n<p>郁闷的是 before call 和 after call 参数都没变，不知道是软件问题还是未注册的原因<br>\n请教了 czy，帮忙逆向了一下，高手就是高手，没多久就给我一段 asm 代码解决了密码复杂度的策略</p>\n<figure class=\"highlight plaintext\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`.386</span><br><span class=\"line\">.model&nbsp;stdcall,flat   option&nbsp;casemap:none   </span><br><span class=\"line\">include&nbsp;\\masm32\\include\\windows.inc   </span><br><span class=\"line\">include&nbsp;\\masm32\\include\\user32.inc   </span><br><span class=\"line\">include&nbsp;\\masm32\\include\\kernel32.inc   </span><br><span class=\"line\">include&nbsp;\\masm32\\include\\masm32.inc   </span><br><span class=\"line\">include&nbsp;\\masm32\\include\\shlwapi.inc   </span><br><span class=\"line\">include&nbsp;\\masm32\\include\\shell32.inc</span><br><span class=\"line\">includelib&nbsp;\\masm32\\lib\\user32.lib   </span><br><span class=\"line\">includelib&nbsp;\\masm32\\lib\\kernel32.lib   </span><br><span class=\"line\">includelib&nbsp;\\masm32\\lib\\masm32.lib   </span><br><span class=\"line\">includelib&nbsp;\\masm32\\lib\\shlwapi.lib   </span><br><span class=\"line\">includelib&nbsp;\\masm32\\lib\\shell32.lib.const`</span><br><span class=\"line\"></span><br><span class=\"line\">`.data`</span><br><span class=\"line\"></span><br><span class=\"line\">`nini&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;'a',0   </span><br><span class=\"line\">seclib&nbsp;&nbsp;db&nbsp;'scecli.dll',0   </span><br><span class=\"line\">myapi&nbsp;&nbsp;&nbsp;db&nbsp;'SceUpdateSecurityProfile',0   </span><br><span class=\"line\">mydata&nbsp;&nbsp;db&nbsp;2eh,01h,00h,00h,0feh,0ffh,0ffh,0ffh,0feh,0ffh,0ffh,0ffh,0feh,0ffh,0ffh,0ffh,00h,00h,00h,00h,0feh,0ffh,0ffh,0ffh,0feh,0ffh,0ffh,0ffh,0feh,0ffh,0ffh,0ffh,0feh,0ffh,0ffh,0ffh,0feh,0ffh,0ffh,0ffh,0feh,0ffh,0ffh,0ffh,00h,00h,00h,00h   ;偏移10H如为0就是禁用,为1就是启用   </span><br><span class=\"line\">.data?  </span><br><span class=\"line\">.code  </span><br><span class=\"line\">start:  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">invoke&nbsp;&nbsp;&nbsp;&nbsp;MessageBox,0,offset&nbsp;nini,offset&nbsp;nini,1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">invoke&nbsp;&nbsp;LoadLibraryA,offset&nbsp;seclib&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">invoke&nbsp;&nbsp;GetProcAddress,eax,offset&nbsp;myapi&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,eax&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">push&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,offset&nbsp;mydata&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">push&nbsp;&nbsp;&nbsp;&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,edi&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">push&nbsp;&nbsp;&nbsp;&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebx,ebx&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">push&nbsp;&nbsp;&nbsp;&nbsp;ebx&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">call&nbsp;&nbsp;&nbsp;&nbsp;esi</span><br><span class=\"line\">invoke&nbsp;&nbsp;&nbsp;&nbsp;ExitProcess,0</span><br><span class=\"line\">end&nbsp;start`</span><br></pre></td></tr></tbody></table></figure>\n<p>编译执行没问题，OK，改成 C<ins> 的版本，老是提示内存不能写（内嵌汇编也不行），还请教了小榕，貌似变量定义的问题<br>\n使用 OD 动态跟踪，发现 asm 版本的生成 exe 后执行 mydata 变量是在.data 可读写数据段里面，而 C</ins> 的版本是在.rdata 只读数据段里面，使用 OD 的时候修改数据测试可以成功，然后再修改 C++ 代码</p>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`<span class=\"meta\">#<span class=\"keyword\">include</span>&nbsp;<span class=\"string\">&lt;stdio.h&gt;</span>   </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span>&nbsp;<span class=\"string\">&lt;windows.h&gt;</span>   </span></span><br><span class=\"line\"><span class=\"type\">char</span>&nbsp;*sam2;   </span><br><span class=\"line\"><span class=\"type\">int</span>&nbsp;<span class=\"title function_\">main</span><span class=\"params\">()</span>   {&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    sam2&nbsp;=&nbsp;new&nbsp;<span class=\"type\">char</span>[<span class=\"number\">99</span>];&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"type\">char</span>&nbsp;*sam&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x2e\\x01\\x00\\x00\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x0fe\\x0ff\\x0ff\\x0ff\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x0fe\\x0ff\\x0ff\\x0ff\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x0fe\\x0ff\\x0ff\\x0ff\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\xfe\\x0ff\\x0ff\\x0ff\\x00\\x00\\x00\\x00\"</span>;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"built_in\">memcpy</span>(sam2,&nbsp;sam,&nbsp;<span class=\"number\">49</span>);&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    HINSTANCE&nbsp;hInst;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    hInst=LoadLibraryA(<span class=\"string\">\"scecli.dll\"</span>);&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    &nbsp;<span class=\"keyword\">typedef</span>&nbsp;<span class=\"title function_\">BOOL</span>&nbsp;<span class=\"params\">(__stdcall&nbsp;*MYFUNC)</span><span class=\"params\">(<span class=\"type\">int</span>,&nbsp;<span class=\"type\">int</span>,&nbsp;<span class=\"type\">char</span>*,&nbsp;<span class=\"type\">int</span>)</span>;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    MYFUNC&nbsp;fun=<span class=\"literal\">NULL</span>;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    fun=(MYFUNC)GetProcAddress(hInst,<span class=\"string\">\"SceUpdateSecurityProfile\"</span>);&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"type\">int</span>&nbsp;i&nbsp;=&nbsp;<span class=\"number\">4</span>;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    fun(<span class=\"literal\">NULL</span>,TRUE,sam2,i);</span><br><span class=\"line\">    <span class=\"comment\">/*&nbsp;&nbsp;&nbsp;&nbsp;__asm   &nbsp;&nbsp;&nbsp;&nbsp;{   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;esi,fun   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;4   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,sam2   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;eax   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;edi,edi   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;edi   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;edi   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;ebx,ebx   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;ebx   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;esi   &nbsp;&nbsp;&nbsp;&nbsp;}   */</span>&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>&nbsp;<span class=\"number\">0</span>;   </span><br><span class=\"line\">    }`</span><br></pre></td></tr></tbody></table></figure>\n<p>或者</p>\n<figure class=\"highlight c\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">`<span class=\"meta\">#<span class=\"keyword\">include</span>&nbsp;<span class=\"string\">&lt;stdio.h&gt;</span>   </span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span>&nbsp;<span class=\"string\">&lt;windows.h&gt;</span>   </span></span><br><span class=\"line\"><span class=\"type\">char</span>&nbsp;sam[]=&nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x2e\\x01\\x00\\x00\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x0fe\\x0ff\\x0ff\\x0ff\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x10\\x00\\x00\\x00\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x0fe\\x0ff\\x0ff\\x0ff\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x0fe\\x0ff\\x0ff\\x0ff\\x0fe\\x0ff\\x0ff\\x0ff\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\xfe\\x0ff\\x0ff\\x0ff\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>   &nbsp;&nbsp;&nbsp;&nbsp;<span class=\"string\">\"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"</span>;</span><br><span class=\"line\"><span class=\"type\">int</span>&nbsp;<span class=\"title function_\">main</span><span class=\"params\">()</span>   {&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    HINSTANCE&nbsp;hInst;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    hInst=LoadLibraryA(<span class=\"string\">\"scecli.dll\"</span>);&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"keyword\">typedef</span>&nbsp;<span class=\"title function_\">BOOL</span>&nbsp;<span class=\"params\">(__stdcall&nbsp;*MYFUNC)</span><span class=\"params\">(<span class=\"type\">int</span>,&nbsp;<span class=\"type\">int</span>,<span class=\"type\">char</span>*,&nbsp;<span class=\"type\">int</span>)</span>;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    MYFUNC&nbsp;fun=<span class=\"literal\">NULL</span>;&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    fun=(MYFUNC)GetProcAddress(hInst,<span class=\"string\">\"SceUpdateSecurityProfile\"</span>);&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"sam=0x%08X\\n\"</span>,&amp;sam);&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">\"%s\"</span>,sam);&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    fun(<span class=\"literal\">NULL</span>,TRUE,sam,<span class=\"number\">4</span>);   </span><br><span class=\"line\">    <span class=\"comment\">/*&nbsp;&nbsp;&nbsp;&nbsp;__asm   &nbsp;&nbsp;&nbsp;&nbsp;{   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;esi,fun   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;4   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,sam2   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;eax   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;edi,edi   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;edi   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;edi   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;ebx,ebx   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;ebx   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;esi   &nbsp;&nbsp;&nbsp;&nbsp;}   */</span>&nbsp;&nbsp;&nbsp;&nbsp;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>&nbsp;<span class=\"number\">0</span>;   </span><br><span class=\"line\">    }`</span><br></pre></td></tr></tbody></table></figure>\n<p>发现如果 <code>SceUpdateSecurityProfile</code> 函数的第三个参数，后面如果有其它数据，会报错，要是后面大段 \\x00 数据的话，就通过，undocument api 只能这样了，估计第三个参数应该是个什么结构。在我的 Windows2003 CN SP1 上测试成功（执行后，会让本地策略 “密码复杂度” 那项变成禁用，还有其它一些策略如审核策略也会更改，应该是第三个参数的每个位对应着不同的策略，安全选项中的似乎不会变），小榕的 Windows2003 EN SP1 上不能成功，估计是这个函数太底层了，应该有更高一层的函数先判断不同的操作系统版本，选择不同的参数，然后在调用 <code>SceUpdateSecurityProfile</code> 函数。<br>\n还有安全选项里面的内容，估计是其它函数，有空我也 softice 一下。</p>\n<p>最后帖下关于变量定义后在内存什么地方的一段代码，不一定什么时候有用</p>\n<figure class=\"highlight cpp\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//main.cpp  </span></span><br><span class=\"line\"><span class=\"type\">int</span> a = <span class=\"number\">0</span>; 全局初始化区  </span><br><span class=\"line\"><span class=\"type\">char</span> \\*p1; 全局未初始化区  </span><br><span class=\"line\"><span class=\"built_in\">main</span>()  </span><br><span class=\"line\">{  </span><br><span class=\"line\"><span class=\"type\">int</span> b; 栈  </span><br><span class=\"line\"><span class=\"type\">char</span> s\\[\\] = <span class=\"string\">\"abc\"</span>; 栈  </span><br><span class=\"line\"><span class=\"type\">char</span> \\*p2; 栈  </span><br><span class=\"line\"><span class=\"type\">char</span> \\*p3 = <span class=\"string\">\"123456\"</span>; <span class=\"number\">123456</span>\\\\<span class=\"number\">0</span>在常量区，p3在栈上。  </span><br><span class=\"line\"><span class=\"type\">static</span> <span class=\"type\">int</span> c =<span class=\"number\">0</span>； 全局（静态）初始化区  </span><br><span class=\"line\">p1 = (<span class=\"type\">char</span> \\*)<span class=\"built_in\">malloc</span>(<span class=\"number\">10</span>);  </span><br><span class=\"line\">p2 = (<span class=\"type\">char</span> \\*)<span class=\"built_in\">malloc</span>(<span class=\"number\">20</span>);  </span><br><span class=\"line\">分配得来得<span class=\"number\">10</span>和<span class=\"number\">20</span>字节的区域就在堆区。  </span><br><span class=\"line\"><span class=\"built_in\">strcpy</span>(p1, <span class=\"string\">\"123456\"</span>); <span class=\"number\">123456</span>\\\\<span class=\"number\">0</span>放在常量区，编译器可能会将它与p3所指向的<span class=\"string\">\"123456\"</span>优化成一个地方。  </span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>全局<br>\nchar *str=“\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20”;<br>\nstr 存在.data 段，是一个指针，内容为一个地址（地址在.rdata 区段），这个地址指向的内容为字符串</p>\n<p>全局<br>\nchar str[]=“\\x20\\x20\\x20\\x20\\x20\\x20\\x20\\x20”;<br>\nstr 存在.data 段，是一个指针，指针指向字符串</p>\n","_path":"20240324/yong-c-xiu-gai-ben-di-an-quan-ce-lue/","_link":"https://yaoqs.github.io/20240324/yong-c-xiu-gai-ben-di-an-quan-ce-lue/","_id":"clzpq9hyf009msgereepqbs4z"}}